@page "/"
@inject GamesClient Client
@inject NavigationManager NavigationManager


<PageTitle>Game Catalog</PageTitle>

<div class="mt-2">
    <a class="btn btn-primary" role="button" href="/editGame">New game</a>    
</div>
@if(games is null){
    <p><em>Loading...</em></p>
}
else{
    <div class="d-flex justify-content-center">
        <div class="col-md-9">
            <form class="mt-3" method="post">
                <label for="ExSymbolInput" class="form-label"></label>
                <InputText id="ExSymbolInput" name="ExSymbolInput" placeholder="Type here..." @bind-Value="ExSymbolInput" class="form-control me-2" />
                <div class="d-flex justify-content-center mt-2">
                    <input  type="submit" value="Show charts"/>
                </div>
                <div id="searchSuggestions">
                    <ul id="suggestionList"></ul>
                </div>

            </form>
        </div>
    </div>
    <table class="table table-striped table-bordered table-hover mt-3"> 
        <thead class="table-dark">
            <th>Symbol</th>
            <th>Name</th>
            <th>Genre</th>
            <th class="text-end">Price</th>
            <th>Release Date</th>
            <th></th>
        </thead>
        <tbody>
            @foreach(var game in games){
                <tr>
                    <td>@game.Id</td>
                    <td>@game.Name</td>
                    <td>@game.Genre</td>
                    <td class="text-end">@game.Price.ToString("C2")</td>
                    <td>@game.ReleaseDate</td>
                    <td>
                        <div class="d-flex">
                            <a class="btn btn-primary me-2" role="button" href="@GameUrl(game.Id)">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="@GetDeleteModalId(game)">
                                    <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <DeleteGame Game = "@game"/>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
<script>
        // Function to handle input change
        async function handleInputChange() {
            const inputText = document.getElementById('ExSymbolInput').value.trim().toLowerCase();

            if (inputText.length === 0) {
                hideSuggestions(); // Hide suggestions if input is empty
                return;
            }

            try {
                const response = await fetch('/exchange_symbols.json');
                if (!response.ok) {
                    throw new Error(`Failed to fetch data (HTTP status ${response.status})`);
                }
                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format: expected an array');
                }

                // Filter data based on the current input text
                const filteredData = data.filter(item => {
                    // Ensure item.name and item.symbol are not null or undefined before lowercasing
                    const nameMatches = (item.name && item.name.toLowerCase().includes(inputText)) || false;
                    const symbolMatches = (item.symbol && item.symbol.toLowerCase().includes(inputText)) || false;
                    return nameMatches || symbolMatches;
                });

                displaySuggestions(filteredData);
            } catch (error) {
                console.error('Error fetching/searching suggestions:', error);
                hideSuggestions(); // Hide suggestions on error
            }
        }

        // Function to display filtered suggestions
        function displaySuggestions(suggestions) {
            const suggestionList = document.getElementById('suggestionList');
            suggestionList.innerHTML = ''; // Clear previous suggestions

            // Display new suggestions
            suggestions.forEach(suggestion => {
                const listItem = document.createElement('li');
                listItem.textContent = `${suggestion.name} (${suggestion.symbol})`;
                listItem.onclick = () => {
                    // Set selected suggestion as input value
                    document.getElementById('ExSymbolInput').value = suggestion.name;
                    hideSuggestions();
                };
                suggestionList.appendChild(listItem);
            });

            // Show the suggestion dropdown
            document.getElementById('searchSuggestions').style.display = 'block';
        }
        // Function to hide the suggestion dropdown
        function hideSuggestions() {
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        // Attach input event listener to the search input field
        document.getElementById('ExSymbolInput').addEventListener('input', handleInputChange);

    </script>

@code {
    private string? ExSymbolInput;
    private GameSummary[]? games;

    protected override void OnInitialized(){
        @* NavigationManager.NavigateTo("/login"); *@
        games = Client.GetGames();
    }
    private static string GameUrl(int Id) => $"/editGame/{Id}";

    private string GetDeleteModalId(GameSummary Game){
        return $"#{DeleteGame.GetModalId(Game)}";
    }
}
